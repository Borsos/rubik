#!/usr/bin/env python3

import sys
import argparse

import random

import numpy as np

from cubist import conf
from cubist.shape import Shape
from cubist.units import Memory
from cubist.cubist import Cubist
from cubist.errors import CubistError, CubistMemoryError
from cubist.filename import InputFilename, OutputFilename
from cubist.extractor import Extractor

from cubist.application import log
from cubist.application import help_functions
from cubist.application.argdict import InputArgDict, OutputArgDict

def _create_cubist(logger, args):
    cubist = Cubist(
            dtype=args.dtype,
            logger=logger,
            input_filenames=args.input_filenames,
            input_dtypes=args.input_dtypes,
            input_formats=args.input_formats,
            output_filenames=args.output_filenames,
            output_dtypes=args.output_dtypes,
            output_formats=args.output_formats,
            shapes=args.shapes,
            extractors=args.extractors,
            input_csv_separators=args.input_csv_separators,
            output_csv_separators=args.output_csv_separators,
            input_text_delimiters=args.input_text_delimiters,
            output_text_delimiters=args.output_text_delimiters,
            output_text_newlines=args.output_text_newlines,
            output_text_converters=args.output_text_converters,
            accept_bigger_raw_files=getattr(args, 'accept_bigger_raw_files', None),
            read_mode=getattr(args, 'read_mode', conf.DEFAULT_READ_MODE),
            optimized_min_size=args.optimized_min_size,
            memory_limit=args.memory_limit,
            split_dimensions=args.split_dimensions,
            clobber=args.clobber,
            print_cube=args.print_cube,
            print_stats=args.print_stats)
    return cubist

def _read(cubist, logger, args):
    expressions = getattr(args, 'expressions', None)
    cubist.read()
    if expressions:
        cubist.evaluate_expressions(*expressions)
    else:
        if args.input_filenames is None or len(args.input_filenames) == 0:
            logger.warning("warning: nothing to do; you should use at least one option between '--input-filename/-i', '--expression/-e'")
        elif len(args.input_filenames) == 0:
            logger.warning("warning: loading more than an input file is useless if '--expression/-e' is not used")

def main_write(logger, args):
    cubist = _create_cubist(logger, args)
    _read(cubist, logger, args)
    if args.in_place:
        if args.output_filenames:
            raise CubistError("--in-place/-Oi is not compatible with --output-filename/-o")
        else:
            for input_filename in args.input_filenames.values():
                args.output_filenames.add(input_filename.filename())
    #print "I", InputFilename.__filenames__
    #print "O", OutputFilename.__filenames__
    cubist.output()
    return 0

def main():

    description = """\
Tool to read/write N-dimensional cubes

Read N-dimensional cubes, extract M-dimensional subcubes, evaluate generic
expressions, and write the result.
"""
    epilog = ""
    
    argdict_input_filenames = InputArgDict(InputFilename)
    argdict_input_dtypes = InputArgDict(conf.get_dtype, default=None)
    argdict_input_formats = InputArgDict(str, default=conf.DEFAULT_FILE_FORMAT)
    argdict_input_csv_separators = InputArgDict(str, default=conf.FILE_FORMAT_CSV_SEPARATOR)
    argdict_input_text_delimiters = InputArgDict(str, default=conf.FILE_FORMAT_TEXT_DELIMITER)
    argdict_shapes = InputArgDict(Shape)
    argdict_extractors = InputArgDict(Extractor, default=None)

    argdict_output_filenames = OutputArgDict(OutputFilename)
    argdict_output_dtypes = OutputArgDict(conf.get_dtype, default=None)
    argdict_output_formats = OutputArgDict(str, default=conf.DEFAULT_FILE_FORMAT)
    argdict_output_csv_separators = OutputArgDict(str, default=conf.FILE_FORMAT_CSV_SEPARATOR)
    argdict_output_text_delimiters = OutputArgDict(str, default=conf.FILE_FORMAT_TEXT_DELIMITER)
    argdict_output_text_newlines = OutputArgDict(str, default=conf.FILE_FORMAT_TEXT_NEWLINE)
    argdict_output_text_converters = OutputArgDict(str, default=conf.FILE_FORMAT_TEXT_CONVERTER)

    parser = argparse.ArgumentParser(
        description=description,
        epilog=epilog,
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )

    parser.set_defaults(
        function=main_write,
    )
    
    global_group = parser.add_argument_group(
        "global options",
        description="""\
Global options""")

    global_group.add_argument("--verbose", "-v",
        dest="verbose_level",
        action="count",
        default=0,
        help="set verbose level")

    global_group.add_argument("--version", "-V",
        action='version',
        version='%(prog)s {version}'.format(version=conf.VERSION))

    global_group.add_argument("--trace-errors", "-E",
        dest="trace_errors",
        action="store_true",
        default=False,
        help="show error traceback")

    global_group.add_argument("--safe",
        dest="read_mode",
        action="store_const",
        const=conf.READ_MODE_SAFE,
        default=conf.DEFAULT_READ_MODE,
        help="safe read mode")

    global_group.add_argument("--optimized",
        dest="read_mode",
        action="store_const",
        const=conf.READ_MODE_OPTIMIZED,
        default=conf.DEFAULT_READ_MODE,
        help="safe read mode")

    global_group.add_argument("--optimized-min-size",
        metavar="S",
        dest="optimized_min_size",
        type=Memory,
        default=conf.DEFAULT_OPTIMIZED_MIN_SIZE,
        help="switch from optimized to safe read mode when reading less than C bytes (a huge value is equivalent to --safe)")

    global_group.add_argument("--memory-limit", "-m",
        metavar="L[units]",
        dest="memory_limit",
        type=Memory,
        default=conf.DEFAULT_LIMIT_MEMORY,
        help="when more than the given limit is needed for a single extracted cube, raise an error")

    global_group.add_argument("--dtype", "-t",
        metavar="D",
        dest="dtype",
        type=conf.get_dtype,
        default=conf.DEFAULT_DATA_TYPE,
        help="data type name (--help-data-types/-hd to show all available data types)")

    global_group.add_argument("--accept-bigger-raw-files", "-a",
        action="store_false",
        default=False,
        help="if an input raw file is bigger than expected, simply issue a warning message")

    global_group.add_argument("--clobber",
        action="store_true",
        default=conf.DEFAULT_CLOBBER,
        help="overwrite existing output files")

    global_group.add_argument("--no-clobber",
        action="store_false",
        default=conf.DEFAULT_CLOBBER,
        help="do not overwrite existing output files")

    global_group.add_argument("--expression", "-e",
        metavar="E",
        dest="expressions",
        type=str,
        action="append",
        default=[],
        help="add an expressions to evaluate (--help-expression/-he for more information)")

    global_group.add_argument("--random-seed", "-r",
        type=int,
        default=None,
        help="set the random seed")

    input_group = parser.add_argument_group(
        "input options",
        description="""\
Options related to input files. All these options can be labeled;
see --help-labeled-options for more information.""")

    input_group.add_argument("--input-filename", "-i",
        metavar='I',
        dest="input_filenames",
        type=argdict_input_filenames.store_function(),
        default=argdict_input_filenames,
        help="input filename (--help-filename/-hf for an explanation about filenames)")

    input_group.add_argument("--shape", "-s",
        metavar="[D0[:D1[...]]]",
        dest="shapes",
        type=argdict_shapes.store_function(),
        default=argdict_shapes,
        help="shape of the input filename")

    input_group.add_argument("--extract", "-x",
        metavar="X",
        dest="extractors",
        type=argdict_extractors.store_function(),
        default=argdict_extractors,
        help="subcube extractor (--help-extractor/-he for more information)")

    input_group.add_argument("--input-dtype", "-It",
        metavar="D",
        dest="input_dtypes",
        type=argdict_input_dtypes.store_function(),
        default=argdict_input_dtypes,
        help="input data type name (--help-data-types/-hd to show all available data types)")

    input_group.add_argument("--input-format", "-If",
        dest="input_formats",
        type=argdict_input_formats.store_function(),
        default=argdict_input_formats,
        help="input file format")

    input_group.add_argument("--input-csv-separator", "-Is",
        metavar='S',
        dest="input_csv_separators",
        type=argdict_input_csv_separators.store_function(),
        default=argdict_input_csv_separators,
        help="separator to be used with '{0}' input file format".format(conf.FILE_FORMAT_CSV))

    input_group.add_argument("--input-text-delimiter", "-Id",
        metavar='D',
        dest="input_text_delimiters",
        type=argdict_input_text_delimiters.store_function(),
        default=argdict_input_text_delimiters,
        help="delimiter to be used with '{0}' input file format".format(conf.FILE_FORMAT_TEXT))

    output_group = parser.add_argument_group(
        "output options",
        description="""\
Options related to output files. All these options can be labeled;
see --help-labeled-options for more information.""")

    write_output_filename_group = output_group.add_mutually_exclusive_group()
    write_output_filename_group.add_argument("--in-place", "-Oi",
        action="store_true",
        help="output filename is input filename (notice that, due to interpolation, output file can be different from input file)")

    write_output_filename_group.add_argument("--output-filename", "-o",
        metavar='O',
        dest="output_filenames",
        type=argdict_output_filenames.store_function(),
        default=argdict_output_filenames,
        help="output filename (--help-filename/-hf for an explanation about filenames)")

    output_group.add_argument('--print', '-P',
        dest="print_cube",
        action="store_true",
        default=False,
        help="print the result cube")

    output_group.add_argument('--stats', '-S',
        dest="print_stats",
        action="store_true",
        default=False,
        help="print statistics about the result cube")

    output_group.add_argument("--split", "-l",
        metavar="D",
        dest="split_dimensions",
        type=int,
        action="append",
        default=[],
        help="split dimension D (--help-split/-hl for more information)")

    output_group.add_argument("--output-dtype", "-Ot",
        metavar="D",
        dest="output_dtypes",
        type=argdict_output_dtypes.store_function(),
        default=argdict_output_dtypes,
        help="output data type name (--help-data-types/-hd to show all available data types)")

    output_group.add_argument("--output-format", "-Of",
        dest="output_formats",
        type=argdict_output_formats.store_function(),
        default=argdict_output_formats,
        help="output file format")

    output_group.add_argument("--output-csv-separator", "-Os",
        metavar='S',
        dest="output_csv_separators",
        type=argdict_output_csv_separators.store_function(),
        default=argdict_output_csv_separators,
        help="separator to be used with '{0}' output file format".format(conf.FILE_FORMAT_CSV))

    output_group.add_argument("--output-text-delimiter", "-Od",
        metavar='D',
        dest="output_text_delimiters",
        type=argdict_output_text_delimiters.store_function(),
        default=argdict_output_text_delimiters,
        help="delimiter to be used with '{0}' output file format".format(conf.FILE_FORMAT_TEXT))

    output_group.add_argument("--output-text-newline", "-On",
        metavar='N',
        dest="output_text_newlines",
        type=argdict_output_text_newlines.store_function(),
        default=argdict_output_text_newlines,
        help="newline to be used with '{0}' output file format".format(conf.FILE_FORMAT_TEXT))

    output_group.add_argument("--output-text-converter", "-Oc",
        metavar='C',
        dest="output_text_converters",
        type=argdict_output_text_converters.store_function(),
        default=argdict_output_text_converters,
        help="converter to be used with '{0}' output file format (e.g. '%%.18e')".format(conf.FILE_FORMAT_TEXT))



    help_group = parser.add_argument_group(
        "help options",
        description="""\
Options to show help on specific topics """)

    help_group.add_argument("--help-dtypes", "-ht",
        dest="help_dtypes",
        action="store_true",
        default=False,
        help="show available dtypes")

    help_group.add_argument("--help-labeled-options", "-ho",
        dest="help_labeled_options",
        action="store_true",
        default=False,
        help="show help about labeled options")

    help_group.add_argument("--help-expression", "-he",
        dest="help_expression",
        action="store_true",
        default=False,
        help="show help about generic expressions")

    help_group.add_argument("--help-extractor", "-hx",
        dest="help_extractor",
        action="store_true",
        default=False,
        help="show help about extractors")

    help_group.add_argument("--help-user-defined-variables", "-hV",
        dest="help_user_defined_variables",
        action="store_true",
        default=False,
        help="show help about user defined variables")

    help_group.add_argument("--help-numpy", "-hn",
        dest="help_numpy",
        action="store_true",
        default=False,
        help="show content of the numpy module")

    help_group.add_argument("--help-cubist-numpy", "-hc",
        dest="help_cubist_numpy",
        action="store_true",
        default=False,
        help="show content of the cubist_numpy module")

    help_group.add_argument("--help-filenames", "-hf",
        dest="help_filenames",
        action="store_true",
        default=False,
        help="show available keywords for filename interpolation")

    help_group.add_argument("--help-split", "-hl",
        dest="help_split",
        action="store_true",
        default=False,
        help="help about splitting dimensions")

    help_group.add_argument("--help-environment-variables", "-hE",
        dest="help_environment_variables",
        action="store_true",
        default=False,
        help="help about environment variables")

    help_group.add_argument("--help-creating-cubes", "-hC",
        dest="help_creating_cubes",
        action="store_true",
        default=False,
        help="how to create cubes from scratch")

    help_group.add_argument("--help-output", "-hO",
        dest="help_output",
        action="store_true",
        default=False,
        help="help about output")

    help_group.add_argument("--help-memory-usage", "-hM",
        dest="help_memory_usage",
        action="store_true",
        default=False,
        help="help about memory usage")

    help_group.add_argument("--help-usage", "-hu",
        dest="help_usage",
        action="store_true",
        default=False,
        help="help about usage: shows some examples and common recipes")

    args = conf.CUBIST_OPTIONS + sys.argv[1:]
    try:
        args = parser.parse_args(args)
    except Exception as err:
        sys.stderr.write("error: {0}: {1}\n".format(err.__class__.__name__, err))
        sys.exit(1)

    help_done = False
    for key in dir(args):
        if key.startswith('help_') and getattr(args, key):
            help_function = getattr(help_functions, key)
            help_function()
            help_done = True
    if help_done:
        sys.exit(0)
        
    logger = log.set_logger(args.verbose_level)
    
    if args.random_seed is not None:
        np.random.seed(args.random_seed)
        random.seed(args.random_seed)

    return_code = 0
    try:
        return_code = args.function(logger, args)
    except CubistMemoryError:
        log.trace_error(args.trace_errors)
        logger.error("error: the memory limit of {0} has been exceeded; you can try to increase the memory limit (--memory-limit/-m)".format(args.memory_limit))
    except:
        log.trace_error(args.trace_errors)

    if return_code:
        sys.exit(return_code)


if __name__ == "__main__":
    main()
